<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <title>Default WebGL!</title>
    <style>
        html,
        body {
            background: url('https://cs460.org/assignments/04/bg.jpg');
            background-size: cover;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden !important;
        }

        #c {
            width: 100%;
            height: 100%;
        }

        #bubble {
        position: absolute;
        left: 45%;
        top: 30%;
        padding: 16px 24px;
        font: 800 24px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: rgba(255,255,255,0.95);
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        transform: translate(-50%, -100%);
        white-space: nowrap;
        pointer-events: none;
        }

        #bubble::after {
        content: "";
        position: absolute;
        left: 50%;        
        bottom: -12px;              
        transform: translateX(-50%);
        width: 0; height: 0;
        border-left: 12px solid transparent;
        border-right: 12px solid transparent;
        border-top: 12px solid rgba(255,255,255,0.95); 
        filter: drop-shadow(0 3px 0 rgba(0,0,0,0.1));
        }

        #play-btn {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 18px;
        font: 600 16px system-ui, sans-serif;
        border: none;
        border-radius: 10px;
        background: rgba(255,255,255,0.85);
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        cursor: pointer;
        }

        #play-btn:hover { 
        background: rgba(255,255,255,1); 
        }
        #bubble, #play-btn {
            opacity: 0;
            transition: opacity 1s ease-in;
        }

    </style>
</head>

<canvas id="c"></canvas>
<div id="bubble">Party under the sea, y'all!</div>
<button id="play-btn">Play Music ðŸŽ¶</button>
<audio id="bg-music" src="https://ia601901.us.archive.org/7/items/01.UnderTheSeaTheLittleMermaid/01.%20Under%20the%20Sea%20-%20The%20Little%20Mermaid.mp3" autoplay muted loop preload="none"></audio>

<script type="text/javascript" src="https://cs460.org/js/glmatrix.js"></script>

<script id="vertexshader" type="glsl">
    attribute vec3 a_position;

    uniform float u_pointsize;

    uniform mat4 u_transform;

    void main(void) {

      vec4 final_position = u_transform * vec4( a_position, 1.);
    
      gl_Position = final_position;
      gl_PointSize = u_pointsize;

    }

  </script>

<script id="fragmentshader" type="glsl">
    precision mediump float;

    uniform vec4 u_color;

    uniform int u_eyeShape;

    void main(void) {
        if (u_eyeShape == 1) {
            float d = distance(gl_PointCoord, vec2(0.5));
            if (d > 0.5) discard;
        }
        gl_FragColor = u_color;

    }
  </script>

<script>

    var c, gl;
    var v_shader, f_shader, shaderprogram;
    var vertices, indices, v_buffer, i_buffer;

    window.onload = function () {

        //************************************************************//
        //
        // INITIALIZE WEBGL
        //
        c = document.getElementById('c'); // setup canvas
        c.width = window.innerWidth;
        c.height = window.innerHeight;

        gl = c.getContext('webgl'); // setup GL context
        gl.viewport(0, 0, c.width, c.height);


        //************************************************************//
        //
        // SHADERS
        //
        v_shader = gl.createShader(gl.VERTEX_SHADER);
        f_shader = gl.createShader(gl.FRAGMENT_SHADER);

        // compile vertex shader
        gl.shaderSource(v_shader, document.getElementById('vertexshader').innerText);
        gl.compileShader(v_shader);

        if (!gl.getShaderParameter(v_shader, gl.COMPILE_STATUS)) {
            console.log(gl.getShaderInfoLog(v_shader));
        }

        // compile fragment shader
        gl.shaderSource(f_shader, document.getElementById('fragmentshader').innerText);
        gl.compileShader(f_shader);

        if (!gl.getShaderParameter(f_shader, gl.COMPILE_STATUS)) {
            console.log(gl.getShaderInfoLog(f_shader));
        }

        // attach and link the shaders
        shaderprogram = gl.createProgram();
        gl.attachShader(shaderprogram, v_shader);
        gl.attachShader(shaderprogram, f_shader);

        gl.linkProgram(shaderprogram);

        gl.useProgram(shaderprogram);


        // create multiple fish
        all_fish = [];
        all_fish.push(createFish(new Float32Array([0, 0, 0]), new Float32Array([1., 0.55, 0., 1.]), 0.8, -1));

        for (var i = 0; i < 100; i++) {
            random_color = [Math.random(),Math.random(),Math.random(),Math.random()];
            random_offset = [Math.random()-Math.random(), Math.random()-Math.random(), 0];
            random_scale = Math.random()*0.3;
            all_fish.push( createFish(random_offset, random_color, random_scale, 1) );
        }

        animate();

        document.getElementById('bubble').style.opacity = '2';
        document.getElementById('play-btn').style.opacity = '2';

    };


    function createFish(offset, color, scale, direction) {

        //************************************************************//
        //
        // CREATE GEOMETRY
        //
        var vertices = new Float32Array([
            0.4, 0.0, 0.0, // 0: nose
            0.1, 0.25, 0.0, // 1: upper body
            -0.2, 0.08, 0.0, // 2: upper tail base
            -0.4, 0.3, 0.0, // 3: upper tail tip
            -0.4, -0.3, 0.0, // 4: lower tail tip
            -0.2, -0.08, 0.0, // 5: lower tail base
            0.1, -0.25, 0.0, // 6: lower body
            -0.3, 0.0, 0.0 // 7: middle of the tail
        ]); 

        // now use indices
        var indices = new Uint8Array([
            0, 1, 6, // main body
            1, 2, 6, // upper mid-body
            2, 5, 6, // rear body
            2, 7, 3, 
            5, 4, 7,
            2, 7, 5 
        ]);

        var eye_vertex = new Float32Array([0.1, 0.1, 0.0])

        if (direction == -1) {
            eye_vertex = new Float32Array([0.17, -0.1, 0.0]);
        }

        // mouth
        var mouthCenter = [0.18, 0.09, 0.0];
        var mouthRadius = -0.03;
        var startDeg = 250.0;
        var endDeg   = 380.0;
        var mouthSegments = 24;
        var mouthVerts = [];
        for (var i = 0; i <= mouthSegments; i++) {
            var t = startDeg + (endDeg - startDeg) * (i / mouthSegments);
            var rad = t * Math.PI / 180.0;
            mouthVerts.push(
                mouthCenter[0] + mouthRadius * Math.cos(rad),
                mouthCenter[1] + mouthRadius * Math.sin(rad),
                0.0
            );
        }

        var mouth_vertex = new Float32Array(mouthVerts);

        var v_buffer = gl.createBuffer(); // create
        gl.bindBuffer(gl.ARRAY_BUFFER, v_buffer); // bind
        gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW); // put data in
        gl.bindBuffer(gl.ARRAY_BUFFER, null); // unbind

        var i_buffer = gl.createBuffer(); // create
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, i_buffer); // bind
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW); // put data in
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null); // unbind

        var eye_v_buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, eye_v_buffer); 
        gl.bufferData(gl.ARRAY_BUFFER, eye_vertex, gl.STATIC_DRAW); 
        gl.bindBuffer(gl.ARRAY_BUFFER, null); 

        var mouth_v_buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, mouth_v_buffer);
        gl.bufferData(gl.ARRAY_BUFFER, mouth_vertex, gl.STATIC_DRAW);
        gl.bindBuffer(gl.ARRAY_BUFFER, null);

        return [v_buffer, i_buffer, eye_v_buffer, offset, color, scale, direction, mouth_v_buffer, mouth_vertex.lengh5 / 3];

    };

    function animate() {

        requestAnimationFrame(animate);

        gl.clearColor(0., 0., 0., 0.)
        gl.clear(gl.COLOR_BUFFER_BIT);
        gl.enable(gl.BLEND);
        gl.blendEquation(gl.FUNC_ADD);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        gl.disable(gl.DEPTH_TEST);


        for (var r = 0; r < all_fish.length; r++) {

            // current_buffers is a list of [v_buffer, i_buffer]-pairs
            var current_buffers = all_fish[r];
            var current_v_buffer = current_buffers[0];
            var current_i_buffer = current_buffers[1];
            var current_eye_v_buffer = current_buffers[2];
            var current_offset = current_buffers[3];
            var current_color = current_buffers[4];
            var current_scale = current_buffers[5];
            var current_direction = current_buffers[6];
            var current_mouth_buf  = current_buffers[7];
            var current_mouth_count= current_buffers[8];
            

            // update offsets

            var frequencyY = 0.8;
            var phaseY = r * 0.6;
            t = performance.now() * 0.01;

            current_offset[0] += 0.003 * current_direction;
            current_offset[1] += 0.005 * Math.sin(t * frequencyY + phaseY);
            if (current_offset[0] >= 1.1) {
                current_direction = -1;
            }

            current_offset[0] *= current_direction;

            theta = 0.05 * Math.sin(t * 0.4 + r * 0.7);

            let transform = [current_direction*current_scale*Math.cos(theta), Math.sin(theta),0,0,
                            -Math.sin(theta), current_direction*current_scale*Math.cos(theta),0,0,
                            0, 0, current_direction*current_scale*1, 0,
                            current_offset[0], current_offset[1], current_offset[2], 1
            ];

            //************************************************************//
            //
            // CONNECT SHADER WITH GEOMETRY
            //

            gl.bindBuffer(gl.ARRAY_BUFFER, current_v_buffer);

            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, current_i_buffer);

            // find the attribute in the shader source
            var a_position = gl.getAttribLocation(shaderprogram, 'a_position');

            gl.vertexAttribPointer(a_position, 3, gl.FLOAT, false, 0, 0);

            gl.enableVertexAttribArray(a_position);

            // find the uniform in the shader source
            var u_transform = gl.getUniformLocation(shaderprogram, 'u_transform');

            gl.uniformMatrix4fv(u_transform, false, new Float32Array(transform));

            var u_color = gl.getUniformLocation(shaderprogram, 'u_color');
            var u_eyeShape = gl.getUniformLocation(shaderprogram, 'u_eyeShape');

            
            var a = 0.6 + 0.4 * Math.sin(t * 2.0);
            current_color = new Float32Array([
                0.3 + 0.2*Math.sin(t + 0.0),
                0.6 + 0.2*Math.sin(t + 2.0),
                0.9 + 0.1*Math.sin(t + 4.0),
                a
            ]);
            if (r == 0) {
            // the large fish aka. first object should still be red!
                current_color = [1, 0, 0, .7];
            }

            gl.uniform1i(u_eyeShape, 0);
            gl.uniform4fv(u_color, current_color);


            //************************************************************//
            //
            // DRAW!
            //

            // gl.drawArrays( gl.TRIANGLES, 0, 6 );
            gl.drawElements(gl.TRIANGLES, 18, gl.UNSIGNED_BYTE, 0);

            // the eye

            gl.uniform1i(u_eyeShape, 1);

            gl.uniform4fv( u_color, new Float32Array([0, 0, 0, .5]));

            var u_pointsize = gl.getUniformLocation( shaderprogram, 'u_pointsize' );

            gl.uniform1fv( u_pointsize, new Float32Array([current_scale*20.]));

            gl.bindBuffer(gl.ARRAY_BUFFER, current_eye_v_buffer);

            gl.vertexAttribPointer(a_position, 3, gl.FLOAT, false, 0, 0);

            gl.enableVertexAttribArray(a_position);

            gl.drawArrays( gl.POINTS, 0, 1);

            // Mouth for red fish only
            if (r === 0) {
                gl.uniform1i(u_eyeShape, 0); 
                gl.uniform4fv(u_color, new Float32Array([0, 0, 0, 0.8]));
                gl.bindBuffer(gl.ARRAY_BUFFER, current_mouth_buf);
                gl.vertexAttribPointer(a_position, 3, gl.FLOAT, false, 0, 0);
                gl.enableVertexAttribArray(a_position);
                gl.drawArrays(gl.LINE_STRIP, 0, current_mouth_count);
            }
        }
    };

</script>

<script>
    const btn   = document.getElementById('play-btn');
    const music = document.getElementById('bg-music');
  
    try { music.load(); } catch (_) {}
  
    btn.onclick = async function () {
      if (music.muted) {
        music.muted = false;
        music.volume = 0.6;
        this.textContent = "Pause Music ðŸ”‡";
        return;
      }
      try {
        if (music.paused) {
          await music.play();
          this.textContent = "Pause Music ðŸ”‡";
        } else {
          music.pause();
          this.textContent = "Play Music ðŸŽ¶";
        }
      } catch (e) {
        console.log('Audio error:', e);
      }
    };
</script>

</html>